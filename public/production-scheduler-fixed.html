<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Production Scheduler (Fixed, Robust Loader)</title>
  <link rel="stylesheet" href="/schedulerpro.umd.js"The filter appears to be working, but there are no operations showing in the time grid. />
  <style>
    :root { --gap: 10px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    #toolbar { margin-bottom: var(--gap); display: flex; gap: var(--gap); align-items: center; }
    button { padding: 6px 12px; border: 1px solid #ddd; background: #fafafa; border-radius: 6px; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    #container { height: 520px; border: 1px solid #eee; border-radius: 8px; }
    #errorPanel { margin-top: var(--gap); padding: 10px 12px; border-radius: 8px; border: 1px solid #f3c2c2; background: #fff6f6; color: #7a1f1f; }
    #log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; background: #0f172a; color: #e2e8f0; padding: 8px 10px; border-radius: 8px; margin-top: var(--gap); }
  </style>
</head>
<body>
  <h2>Production Scheduler</h2>

  <div id="toolbar">
    <button id="forwardBtn" disabled>Forward Schedule (ASAP)</button>
    <button id="backwardBtn" disabled>Backward Schedule (ALAP)</button>
    <span id="status">Loading Bryntum…</span>
  </div>

  <div id="container"></div>

  <div id="errorPanel" hidden>
    <strong>Could not load Bryntum Scheduler Pro.</strong>
    <div>
      The <code>bryntum</code> namespace was not found. This usually means the external script could not be fetched from the CDN in this sandboxed environment.
      You can still review the page without runtime errors. See the log below for details.
    </div>
  </div>

  <div id="log" aria-live="polite"></div>

  <script>
    const BRYNTUM_VERSION = '6.3.3';
    const BRYNTUM_BASE = `https://cdn.bryntum.com/schedulerpro/${BRYNTUM_VERSION}`;
    const BRYNTUM_SCRIPT = `${BRYNTUM_BASE}/schedulerpro.umd.js`;

    const logEl = document.getElementById('log');
    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
    }

    async function loadBryntum() {
      if (window.bryntum?.schedulerpro?.SchedulerPro) {
        log('Bryntum already present.');
        return true;
      }
      return new Promise((resolve) => {
        const s = document.createElement('script');
        s.src = BRYNTUM_SCRIPT;
        s.async = true;
        s.crossOrigin = 'anonymous';
        s.onload = () => {
          if (window.bryntum?.schedulerpro?.SchedulerPro) {
            log('Bryntum loaded from CDN.');
            resolve(true);
          } else {
            log('Script loaded but SchedulerPro not found on window.bryntum.');
            resolve(false);
          }
        };
        s.onerror = () => {
          log(`Failed to load: ${BRYNTUM_SCRIPT}`);
          resolve(false);
        };
        document.head.appendChild(s);
      });
    }

    let scheduler = null;
    async function initScheduler() {
      const ok = await loadBryntum();
      const status = document.getElementById('status');
      const errorPanel = document.getElementById('errorPanel');
      const fwdBtn = document.getElementById('forwardBtn');
      const bwdBtn = document.getElementById('backwardBtn');

      if (!ok) {
        status.textContent = 'Bryntum not available';
        errorPanel.hidden = false;
        log('Running in fallback mode. No Scheduler will be instantiated.');
        return;
      }

      try {
        const { SchedulerPro } = window.bryntum.schedulerpro;

        scheduler = new SchedulerPro({
          appendTo   : 'container',
          startDate  : new Date(2025, 9, 20, 8),
          endDate    : new Date(2025, 9, 20, 18),
          viewPreset : 'hourAndDay',

          project : {
            autoCalculate        : true,
            recalculateAfterLoad : true,
            constraintsMode      : 'honor',
            schedulingDirection  : 'forward',
            allowDependencyLag   : true,
            calculateCriticalPath: true
          },

          columns : [
            { type: 'resourceInfo', text: 'Resource', field: 'name', width: 160 }
          ],

          resources : [
            { id : 1, name : 'Machine A' },
            { id : 2, name : 'Machine B' }
          ],

          events : [
            { id : 1, name : 'Operation 1', resourceId : 1, startDate : '2025-10-20T08:00', duration : 2, durationUnit : 'h' },
            { id : 2, name : 'Operation 2', resourceId : 1, startDate : '2025-10-20T11:00', duration : 2, durationUnit : 'h' },
            { id : 3, name : 'Operation 3', resourceId : 2, startDate : '2025-10-20T09:00', duration : 3, durationUnit : 'h' }
          ],

          dependencies : [
            { fromEvent : 1, toEvent : 2, type : 0 },
            { fromEvent : 2, toEvent : 3, type : 0 }
          ],

          listeners : {
            beforeCalculate() { log('⏳ Scheduling calculation starting…'); },
            calculate()       { log('✅ Scheduling calculation complete.'); },
            conflict({ conflict }) { log('⚠️ Conflict: ' + (conflict?.description || 'See console')); }
          }
        });

        fwdBtn.disabled = false;
        bwdBtn.disabled = false;
        status.textContent = 'Ready';

        fwdBtn.addEventListener('click', () => runScheduling('ASAP'));
        bwdBtn.addEventListener('click', () => runScheduling('ALAP'));
      } catch (e) {
        log('Initialization error: ' + (e && e.message ? e.message : e));
        status.textContent = 'Init error';
        errorPanel.hidden = false;
      }
    }

    async function runScheduling(mode) {
      if (!scheduler) return;
      scheduler.project.schedulingDirection = mode === 'ALAP' ? 'backward' : 'forward';
      await scheduler.project.propagate();
      if (scheduler.toast) scheduler.toast(`Schedule recalculated (${mode})`);
      log(`Recalculated with mode: ${mode}`);
    }

    initScheduler();
  </script>
</body>
</html>