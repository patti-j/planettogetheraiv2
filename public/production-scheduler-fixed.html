<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Schedule - PlanetTogether</title>
    
    <!-- Bryntum Scheduler Pro Stockholm Light Theme CSS -->
    <link rel="stylesheet" href="/stockholm-light.css">
    
    <!-- FontAwesome (required separately in v7.0.0) -->
    <link rel="stylesheet" href="/fontawesome/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            display: flex;
            flex-direction: column;
        }
        
        .header {
            padding: 1rem 2rem;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: #333;
        }
        
        .toolbar {
            padding: 0.5rem 2rem;
            background: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .toolbar select, .toolbar button {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }
        
        .toolbar button:hover {
            background: #f5f5f5;
        }
        
        #schedulerContainer {
            flex: 1;
            position: relative;
        }
        
        .status-bar {
            padding: 0.5rem 2rem;
            background: #f5f5f5;
            border-top: 1px solid #ddd;
            font-size: 0.875rem;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        
        .error-message {
            padding: 2rem;
            text-align: center;
            color: #d32f2f;
            background: #ffebee;
            margin: 2rem;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Production Schedule</h1>
        <span id="lastUpdated">Last updated: -</span>
    </div>
    
    <div class="toolbar">
        <label>View:</label>
        <select id="viewSelector">
            <option value="hourAndDay">Hour & Day</option>
            <option value="weekAndDay" selected>Week & Day</option>
            <option value="monthAndYear">Month & Year</option>
        </select>
        
        <button id="zoomIn">Zoom In</button>
        <button id="zoomOut">Zoom Out</button>
        <button id="zoomToFit">Fit to View</button>
    </div>
    
    <div id="schedulerContainer"></div>
    
    <div class="status-bar">
        <span id="statusMessage">Loading...</span>
        <span id="resourceUtilization">-</span>
    </div>
    
    <!-- Bryntum SchedulerPro UMD library -->
    <script src="/schedulerpro.umd.js"></script>
    
    <script>
        let scheduler = null;
        
        async function initializeScheduler() {
            try {
                console.log('üöÄ Initializing Bryntum Scheduler Pro v7.0.0-alpha.1 with Stockholm theme');
                
                // Verify Bryntum is loaded
                if (typeof bryntum === 'undefined' || !bryntum.schedulerpro) {
                    throw new Error('Bryntum SchedulerPro library not loaded');
                }
                
                console.log('‚úÖ Bryntum library loaded');
                
                // Get the required classes
                const { SchedulerPro, ProjectModel } = bryntum.schedulerpro;
                
                if (!SchedulerPro || !ProjectModel) {
                    throw new Error('Required Bryntum classes not found');
                }
                
                console.log('‚úÖ Found SchedulerPro and ProjectModel constructors');
                
                // Load resources from API
                let resourcesData = [];
                let eventsData = [];
                
                try {
                    const resResponse = await fetch('/api/ptresources');
                    if (resResponse.ok) {
                        const ptResources = await resResponse.json();
                        resourcesData = ptResources.map(res => ({
                            id: res.resource_id || res.id,
                            name: res.name || `Resource ${res.id}`,
                            calendar: 'general'
                        }));
                        console.log(`‚úÖ Loaded ${resourcesData.length} resources from database`);
                    }
                } catch (error) {
                    console.warn('Could not load resources:', error);
                }
                
                // Load operations as events
                try {
                    const opsResponse = await fetch('/api/ptoperations');
                    if (opsResponse.ok) {
                        const ptOperations = await opsResponse.json();
                        const baseDate = new Date('2025-09-03T08:00:00');
                        
                        eventsData = ptOperations.map((op, index) => {
                            const startDate = new Date(baseDate);
                            startDate.setDate(startDate.getDate() + Math.floor(index / 4));
                            startDate.setHours(8 + (index % 4) * 3, 0, 0, 0);
                            
                            const duration = parseFloat(op.cycle_hrs) || 2;
                            
                            return {
                                id: index + 1,
                                name: op.name || `Operation ${op.id}`,
                                startDate: startDate.toISOString(),
                                duration: duration,
                                durationUnit: 'hour',
                                constraintType: 'muststarton',
                                constraintDate: startDate.toISOString()
                            };
                        });
                        console.log(`‚úÖ Loaded ${eventsData.length} operations from database`);
                    }
                } catch (error) {
                    console.warn('Could not load operations:', error);
                }
                
                // If no data from API, use demo data
                if (resourcesData.length === 0) {
                    console.log('üìä Using demo resources');
                    resourcesData = [
                        { id: 1, name: 'Bottle Filler Line', calendar: 'general' },
                        { id: 2, name: 'Brew Kettle 1', calendar: 'general' },
                        { id: 3, name: 'Bright Tank 1', calendar: 'general' },
                        { id: 4, name: 'Packaging Line A', calendar: 'general' }
                    ];
                }
                
                if (eventsData.length === 0) {
                    console.log('üìä Using demo operations');
                    eventsData = [
                        { 
                            id: 1, 
                            name: 'Mix Batch A-1', 
                            startDate: '2025-09-03T08:00:00',
                            duration: 3,
                            durationUnit: 'hour'
                        },
                        { 
                            id: 2, 
                            name: 'Fill Bottles - Batch A-1', 
                            startDate: '2025-09-03T12:00:00',
                            duration: 2,
                            durationUnit: 'hour'
                        },
                        { 
                            id: 3, 
                            name: 'Quality Check', 
                            startDate: '2025-09-03T15:00:00',
                            duration: 1,
                            durationUnit: 'hour'
                        }
                    ];
                }
                
                // Create assignments data (link events to resources)
                const assignmentsData = eventsData.map((event, index) => ({
                    id: index + 1,
                    event: event.id,
                    resource: resourcesData[index % resourcesData.length].id,
                    units: 100
                }));
                
                console.log('üìä Creating ProjectModel');
                
                // Create project model
                const project = new ProjectModel({
                    startDate: '2025-09-02',
                    
                    // Define calendar
                    calendarsData: [{
                        id: 'general',
                        name: 'General',
                        intervals: [
                            {
                                recurrentStartDate: 'on Mon at 08:00',
                                recurrentEndDate: 'on Mon at 17:00',
                                isWorking: true
                            },
                            {
                                recurrentStartDate: 'on Tue at 08:00',
                                recurrentEndDate: 'on Tue at 17:00',
                                isWorking: true
                            },
                            {
                                recurrentStartDate: 'on Wed at 08:00',
                                recurrentEndDate: 'on Wed at 17:00',
                                isWorking: true
                            },
                            {
                                recurrentStartDate: 'on Thu at 08:00',
                                recurrentEndDate: 'on Thu at 17:00',
                                isWorking: true
                            },
                            {
                                recurrentStartDate: 'on Fri at 08:00',
                                recurrentEndDate: 'on Fri at 17:00',
                                isWorking: true
                            }
                        ]
                    }],
                    
                    // Load data
                    resourcesData: resourcesData,
                    eventsData: eventsData,
                    assignmentsData: assignmentsData
                });
                
                console.log('üìä Creating SchedulerPro with Stockholm theme');
                
                // Create scheduler
                scheduler = new SchedulerPro({
                    appendTo: 'schedulerContainer',
                    
                    // Link to project
                    project: project,
                    
                    // Time range
                    startDate: new Date('2025-09-02'),
                    endDate: new Date('2025-09-16'),
                    
                    // View configuration
                    viewPreset: 'weekAndDay',
                    rowHeight: 60,
                    barMargin: 8,
                    
                    // Columns
                    columns: [
                        { 
                            type: 'resourceInfo',
                            text: 'Resources', 
                            field: 'name', 
                            width: 220
                        }
                    ],
                    
                    // Features
                    features: {
                        eventDrag: true,
                        eventResize: true,
                        eventTooltip: true,
                        percentBar: true,
                        dependencies: true,
                        timeRanges: {
                            showCurrentTimeLine: true
                        }
                    },
                    
                    // Event listeners
                    listeners: {
                        paint: () => {
                            console.log('‚úÖ Scheduler painted successfully');
                            updateStatus();
                        }
                    }
                });
                
                console.log('‚úÖ Scheduler created and attached to DOM');
                
                // Set up toolbar handlers
                setupToolbarHandlers();
                
                // Update last updated time
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${new Date().toLocaleTimeString()}`;
                
            } catch (error) {
                console.error('‚ùå Failed to initialize scheduler:', error);
                document.getElementById('schedulerContainer').innerHTML = `
                    <div class="error-message">
                        Failed to initialize scheduler: ${error.message}
                    </div>
                `;
            }
        }
        
        function setupToolbarHandlers() {
            // View selector
            document.getElementById('viewSelector').addEventListener('change', (e) => {
                if (scheduler) {
                    scheduler.viewPreset = e.target.value;
                    console.log(`Changed view to: ${e.target.value}`);
                }
            });
            
            // Zoom controls
            document.getElementById('zoomIn').addEventListener('click', () => {
                if (scheduler) scheduler.zoomIn();
            });
            
            document.getElementById('zoomOut').addEventListener('click', () => {
                if (scheduler) scheduler.zoomOut();
            });
            
            document.getElementById('zoomToFit').addEventListener('click', () => {
                if (scheduler) scheduler.zoomToFit();
            });
        }
        
        function updateStatus() {
            if (!scheduler) return;
            
            const eventCount = scheduler.eventStore?.count || 0;
            const resourceCount = scheduler.resourceStore?.count || 0;
            
            // Calculate total scheduled hours
            let totalHours = 0;
            scheduler.eventStore?.forEach(event => {
                totalHours += event.duration || 0;
            });
            
            // Calculate utilization (simplified)
            const availableHours = resourceCount * 8 * 10; // 10 working days
            const utilization = availableHours > 0 
                ? Math.round((totalHours / availableHours) * 100)
                : 0;
            
            document.getElementById('statusMessage').textContent = 
                `${eventCount} operations scheduled`;
            document.getElementById('resourceUtilization').textContent = 
                `Resource utilization: ${utilization}% (${totalHours.toFixed(1)}h total)`;
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeScheduler);
        } else {
            initializeScheduler();
        }
    </script>
</body>
</html>