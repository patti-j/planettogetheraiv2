<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Force refresh timestamp: 2025-10-09 v7.0.0 -->
    <title>Production Schedule - PlanetTogether</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <!-- FontAwesome (now required separately in v7.0.0) - Using local copy -->
    <link rel="stylesheet" href="/fontawesome/css/all.min.css">
    
    <!-- Bryntum Scheduler Pro CSS - Base styles MUST be loaded first -->
    <link rel="stylesheet" href="/schedulerpro.css">
    
    <!-- Stockholm Light theme overlay - loaded on top of base styles -->
    <link rel="stylesheet" href="/stockholm-light.css?v=7" id="scheduler-theme">
    
    <!-- CRITICAL: Load Bryntum Scheduler Pro library in HEAD (required for initialization) -->
    <script src="/schedulerpro.umd.js"></script>
    
    <style>
        /* Minimal page layout styles only - let Bryntum handle all component styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }
        
        body {
            display: flex;
            flex-direction: column;
        }
        
        /* Header styles */
        .header {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 100;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a1a1a;
        }
        
        .header .last-updated {
            font-size: 0.875rem;
            color: #666;
        }
        
        /* Toolbar styles */
        .toolbar {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            z-index: 100;
        }
        
        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .toolbar label {
            font-size: 0.875rem;
            color: #666;
            font-weight: 500;
        }
        
        .toolbar select,
        .toolbar button {
            padding: 0.5rem 1rem;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            background: white;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .toolbar select:hover,
        .toolbar button:hover {
            background: #f8f8f8;
            border-color: #b0b0b0;
        }
        
        .toolbar button:active {
            transform: translateY(1px);
        }
        
        /* Container for scheduler - fills remaining space */
        #schedulerContainer {
            flex: 1;
            position: relative;
            background: #fff;
            overflow: hidden;
        }
        
        /* Status bar */
        .status-bar {
            background: #fff;
            border-top: 1px solid #e0e0e0;
            padding: 0.5rem 1.5rem;
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #666;
            z-index: 100;
        }
        
        .status-bar .status-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .status-bar .status-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
        }
        
        /* Loading and error states */
        .loading-message,
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 2rem;
            border-radius: 8px;
        }
        
        .loading-message {
            color: #666;
            background: #f5f5f5;
        }
        
        .error-message {
            color: #d32f2f;
            background: #ffebee;
            border: 1px solid #ffcdd2;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 1rem;
            border: 3px solid #e0e0e0;
            border-top-color: #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Production Schedule</h1>
        <span class="last-updated" id="lastUpdated">Last updated: -</span>
    </div>
    
    <div class="toolbar">
        <div class="toolbar-group">
            <label for="viewSelector">View:</label>
            <select id="viewSelector">
                <option value="hourAndDay">Hour & Day</option>
                <option value="dayAndWeek" selected>Day & Week</option>
                <option value="weekAndMonth">Week & Month</option>
                <option value="monthAndYear">Month & Year</option>
            </select>
        </div>
        
        <div class="toolbar-group">
            <label>Algorithm:</label>
            <select id="algorithmSelector">
                <option value="ASAP">ASAP (Forward)</option>
                <option value="ALAP">ALAP (Backward)</option>
                <option value="Critical">Critical Path</option>
                <option value="Resource">Resource Leveling</option>
            </select>
            <button id="applyAlgorithm">Apply</button>
            <button id="saveSchedule">Save</button>
        </div>
    </div>
    
    <div id="schedulerContainer">
        <div class="loading-message">
            <div class="spinner"></div>
            <div>Initializing Production Scheduler...</div>
        </div>
    </div>
    
    <div class="status-bar">
        <div class="status-item">
            <span class="status-icon"></span>
            <span id="statusMessage">Loading resources...</span>
        </div>
        <span id="resourceUtilization">-</span>
    </div>
    
    <script>
        // Cache buster using useRef equivalent (stable value)
        const CACHE_BUSTER = 'v7_' + Math.floor(Date.now() / 60000);
        
        console.log('üöÄ Starting application initialization...');
        
        // Initialize scheduler when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeScheduler);
        } else {
            initializeScheduler();
        }
        
        // Global scheduler instance
        let scheduler = null;
        let projectModel = null;
        
        async function initializeScheduler() {
            try {
                // Verify Bryntum is loaded
                if (typeof bryntum === 'undefined') {
                    throw new Error('Bryntum library not loaded');
                }
                
                console.log('‚úÖ Bryntum library ready');
                
                // Get required classes from bryntum.schedulerpro namespace
                const { SchedulerPro, ProjectModel } = bryntum.schedulerpro;
                
                if (!SchedulerPro || !ProjectModel) {
                    throw new Error('Required Bryntum classes not found');
                }
                
                console.log('üìä Loading data from API...');
                
                // Load resources from PT database
                let resources = [];
                let events = [];
                
                try {
                    const [resResponse, opsResponse] = await Promise.all([
                        fetch('/api/ptresources'),
                        fetch('/api/ptoperations')
                    ]);
                    
                    if (resResponse.ok) {
                        const ptResources = await resResponse.json();
                        resources = ptResources.map(res => ({
                            id: res.resource_id || res.id,
                            name: res.name || `Resource ${res.id}`,
                            calendar: 'general'
                        }));
                        console.log(`‚úÖ Loaded ${resources.length} resources from PT database`);
                    }
                    
                    if (opsResponse.ok) {
                        const ptOperations = await opsResponse.json();
                        const baseDate = new Date('2024-09-03T08:00:00');
                        
                        events = ptOperations.map((op, index) => {
                            const startDate = new Date(baseDate);
                            startDate.setDate(startDate.getDate() + Math.floor(index / 4));
                            startDate.setHours(8 + (index % 4) * 3, 0, 0, 0);
                            
                            const duration = parseFloat(op.cycle_hrs) || 2;
                            const endDate = new Date(startDate);
                            endDate.setHours(endDate.getHours() + duration);
                            
                            // Assign to resources in round-robin fashion
                            const resourceId = resources.length > 0 
                                ? resources[index % resources.length].id 
                                : 1;
                            
                            return {
                                id: op.id || index + 1,
                                name: op.name || `Operation ${op.id}`,
                                resourceId: resourceId, // Direct assignment for resource view
                                startDate: startDate,
                                endDate: endDate,
                                duration: duration,
                                durationUnit: 'hour',
                                percentDone: Math.floor(Math.random() * 100)
                            };
                        });
                        console.log(`‚úÖ Created ${events.length} events from PT operations`);
                    }
                } catch (error) {
                    console.warn('Could not load data from API, using demo data:', error);
                }
                
                // Fallback demo data if needed
                if (resources.length === 0) {
                    resources = [
                        { id: 'r1', name: 'Bottle Filler Line', calendar: 'general' },
                        { id: 'r2', name: 'Brew Kettle 1', calendar: 'general' },
                        { id: 'r3', name: 'Bright Tank 1', calendar: 'general' },
                        { id: 'r4', name: 'Packaging Line A', calendar: 'general' }
                    ];
                }
                
                if (events.length === 0) {
                    const now = new Date();
                    events = [
                        {
                            id: 1,
                            resourceId: 'r1',
                            name: 'Mix Batch A-1',
                            startDate: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 8, 0),
                            endDate: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 11, 0),
                            percentDone: 75
                        },
                        {
                            id: 2,
                            resourceId: 'r2',
                            name: 'Brew Batch B-2',
                            startDate: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 9, 0),
                            endDate: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 14, 0),
                            percentDone: 50
                        },
                        {
                            id: 3,
                            resourceId: 'r3',
                            name: 'Quality Check',
                            startDate: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0),
                            endDate: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 13, 0),
                            percentDone: 25
                        },
                        {
                            id: 4,
                            resourceId: 'r4',
                            name: 'Package Product',
                            startDate: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 14, 0),
                            endDate: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 17, 0),
                            percentDone: 0
                        }
                    ];
                }
                
                console.log('üîß Creating ProjectModel...');
                
                // Create project model with calendar
                projectModel = new ProjectModel({
                    calendar: 'general',
                    startDate: events[0]?.startDate || new Date(),
                    
                    calendarsData: [{
                        id: 'general',
                        name: 'General',
                        intervals: [
                            {
                                recurrentStartDate: 'on Mon at 8:00',
                                recurrentEndDate: 'on Mon at 17:00',
                                isWorking: true
                            },
                            {
                                recurrentStartDate: 'on Tue at 8:00',
                                recurrentEndDate: 'on Tue at 17:00',
                                isWorking: true
                            },
                            {
                                recurrentStartDate: 'on Wed at 8:00',
                                recurrentEndDate: 'on Wed at 17:00',
                                isWorking: true
                            },
                            {
                                recurrentStartDate: 'on Thu at 8:00',
                                recurrentEndDate: 'on Thu at 17:00',
                                isWorking: true
                            },
                            {
                                recurrentStartDate: 'on Fri at 8:00',
                                recurrentEndDate: 'on Fri at 17:00',
                                isWorking: true
                            }
                        ]
                    }],
                    
                    resourcesData: resources,
                    eventsData: events
                });
                
                console.log('üé® Creating SchedulerPro with Stockholm theme...');
                
                // Clear loading message
                document.getElementById('schedulerContainer').innerHTML = '';
                
                // Calculate date range
                const startDate = events[0]?.startDate || new Date();
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 14); // Show 2 weeks
                
                // Create the SchedulerPro instance with resource view
                scheduler = new SchedulerPro({
                    appendTo: 'schedulerContainer',
                    
                    // Use the project model
                    project: projectModel,
                    
                    // Resource scheduling view configuration
                    startDate: startDate,
                    endDate: endDate,
                    
                    // View preset for proper timeline display
                    viewPreset: 'dayAndWeek',
                    
                    // Row configuration for resources
                    rowHeight: 60,
                    barMargin: 8,
                    
                    // Resource columns configuration
                    columns: [
                        { 
                            type: 'resourceInfo',
                            text: 'Resources',
                            field: 'name',
                            width: 220,
                            showEventCount: true,
                            showImage: false
                        }
                    ],
                    
                    // Enable scheduling features
                    features: {
                        eventDrag: true,
                        eventResize: true,
                        eventEdit: true,
                        eventTooltip: {
                            template: (data) => `
                                <div class="b-sch-event-tooltip">
                                    <div><b>${data.eventRecord.name}</b></div>
                                    <div>Start: ${data.eventRecord.startDate.toLocaleString()}</div>
                                    <div>End: ${data.eventRecord.endDate.toLocaleString()}</div>
                                    <div>Duration: ${data.eventRecord.duration} ${data.eventRecord.durationUnit}</div>
                                    <div>Progress: ${data.eventRecord.percentDone || 0}%</div>
                                </div>
                            `
                        },
                        percentBar: true,
                        dependencies: true,
                        timeRanges: {
                            showCurrentTimeLine: true
                        },
                        nonWorkingTime: true,
                        tree: false, // Disable tree view for flat resource list
                        regionResize: true
                    },
                    
                    // Event renderer for custom styling
                    eventRenderer({ eventRecord, renderData }) {
                        renderData.cls.add('custom-event');
                        if (eventRecord.percentDone > 0) {
                            renderData.cls.add('has-progress');
                        }
                        return eventRecord.name;
                    },
                    
                    // Handle scheduler events
                    listeners: {
                        paint: () => {
                            console.log('‚úÖ Scheduler painted successfully with Stockholm theme');
                            updateStatus();
                        },
                        eventDrop: ({ eventRecords }) => {
                            console.log('üìÖ Event moved:', eventRecords);
                            updateStatus();
                        },
                        eventResizeEnd: ({ eventRecord }) => {
                            console.log('üìê Event resized:', eventRecord);
                            updateStatus();
                        }
                    }
                });
                
                console.log('‚úÖ SchedulerPro initialized with resource view');
                
                // Set up toolbar handlers
                setupToolbarHandlers();
                
                // Update last updated time
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${new Date().toLocaleTimeString()}`;
                
                // Clear loading state
                updateStatus();
                
            } catch (error) {
                console.error('‚ùå Failed to initialize scheduler:', error);
                document.getElementById('schedulerContainer').innerHTML = `
                    <div class="error-message">
                        <h3>Failed to initialize Production Scheduler</h3>
                        <p>${error.message}</p>
                        <p>Please refresh the page or contact support.</p>
                    </div>
                `;
            }
        }
        
        function setupToolbarHandlers() {
            // View preset selector
            document.getElementById('viewSelector').addEventListener('change', (e) => {
                if (scheduler) {
                    scheduler.viewPreset = e.target.value;
                    console.log(`üìä Changed view to: ${e.target.value}`);
                }
            });
            
            // Algorithm selector and apply button
            document.getElementById('applyAlgorithm').addEventListener('click', () => {
                const algorithm = document.getElementById('algorithmSelector').value;
                console.log(`üîÑ Applying ${algorithm} algorithm...`);
                
                // Here you would implement the scheduling algorithm
                // For now, just show a message
                document.getElementById('statusMessage').textContent = 
                    `Applied ${algorithm} scheduling algorithm`;
                
                setTimeout(() => updateStatus(), 2000);
            });
            
            // Save button
            document.getElementById('saveSchedule').addEventListener('click', () => {
                console.log('üíæ Saving schedule...');
                
                // Here you would save to backend
                document.getElementById('statusMessage').textContent = 'Schedule saved';
                
                setTimeout(() => updateStatus(), 2000);
            });
        }
        
        function updateStatus() {
            if (!scheduler || !scheduler.eventStore) return;
            
            const eventCount = scheduler.eventStore.count;
            const resourceCount = scheduler.resourceStore?.count || 0;
            
            // Calculate total scheduled hours
            let totalHours = 0;
            scheduler.eventStore.forEach(event => {
                totalHours += event.duration || 0;
            });
            
            // Calculate utilization (simplified)
            const availableHours = resourceCount * 8 * 10; // 10 working days
            const utilization = availableHours > 0 
                ? Math.round((totalHours / availableHours) * 100)
                : 0;
            
            document.getElementById('statusMessage').textContent = 
                `${eventCount} operations scheduled`;
            document.getElementById('resourceUtilization').textContent = 
                `Resource utilization: ${utilization}% (${totalHours.toFixed(1)}h total)`;
        }
    </script>
</body>
</html>