<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Production Schedule - PlanetTogether</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <!-- Bryntum Scheduler Pro CSS -->
    <link rel="stylesheet" href="/schedulerpro.classic-light.css?v=4" id="scheduler-theme">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
        }

        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .scheduler-container {
            flex: 1;
            position: relative;
            background: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #scheduler {
            flex: 1;
            min-height: 0;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ff4444;
            color: white;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem;
            text-align: center;
        }
        
        /* Customize Bryntum styles for PlanetTogether branding */
        .b-sch-event {
            border-radius: 6px !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12) !important;
        }
        
        .b-sch-event:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        
        /* Dependency lines styling */
        .b-sch-dependency {
            stroke: #666 !important;
            stroke-width: 2 !important;
            opacity: 0.8 !important;
        }
        
        .b-sch-dependency-arrow {
            fill: #666 !important;
            stroke: #666 !important;
        }
        
        .b-sch-dependency:hover {
            stroke: #333 !important;
            stroke-width: 3 !important;
            opacity: 1 !important;
        }
        
        /* Critical path dependency styling */
        .b-sch-dependency.b-critical {
            stroke: #ff4444 !important;
            stroke-width: 3 !important;
        }
        
        .b-sch-dependency.b-critical .b-sch-dependency-arrow {
            fill: #ff4444 !important;
            stroke: #ff4444 !important;
        }
    </style>
</head>
<body>
    <div class="scheduler-container">
        <div id="scheduler"></div>
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Bryntum Scheduler Pro JavaScript -->
    <script src="/schedulerpro.umd.js?v=4"></script>
    
    <!-- Toast utility (simple implementation) -->
    <script>
        const Toast = {
            show: function(message) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #333;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 6px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 3000);
            }
        };
        
        // Add animation styles
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>

    <script>
        // Initialize Bryntum Scheduler Pro
        const targetElement = document.getElementById('scheduler');
        const { SchedulerPro } = bryntum.schedulerpro;
        
        // Create scheduler instance
        const schedulerPro = new SchedulerPro({
            project : {
                autoLoad  : true,
                transport : {
                    load : {
                        url : 'data/SchedulerPro/examples/guides/readme/intro.json'
                    }
                }
            },
            style             : 'font-size:0.85em',
            resourceImagePath : 'data/Scheduler/images/users/',
            appendTo          : targetElement,
            autoHeight        : true,
            eventStyle        : 'rounded',
            startDate         : new Date(2025, 2, 23, 4),
            endDate           : new Date(2025, 2, 26),
            // Custom view preset, with more compact display of hours
            viewPreset        : {
                base      : 'hourAndDay',
                tickWidth : 35,
                headers   : [
                    {
                        unit       : 'day',
                        dateFormat : 'ddd DD/MM' //Mon 01/10
                    },
                    {
                        unit       : 'hour',
                        dateFormat : 'H'
                    }
                ]
            },

            features : {
                timeRanges : {
                    narrowThreshold : 10,
                    enableResizing  : true
                },
                resourceNonWorkingTime : true,
                cellEdit               : true,
                filter                 : true,
                regionResize           : true,
                dependencies           : true,
                dependencyEdit         : true,
                percentBar             : true,
                group                  : 'type',
                sort                   : 'name',
                eventTooltip           : {
                    header : {
                        title      : 'Information',
                        titleAlign : 'start'
                    },
                    tools : [
                        {
                            cls : 'b-fa b-fa-trash',
                            handler() {
                                this.eventRecord.remove();
                                this.hide();
                            }
                        },
                        {
                            cls : 'b-fa b-fa-edit',
                            handler() {
                                schedulerPro.features.taskEdit.editEvent(this.eventRecord);
                            }
                        }
                    ]
                }
            },

            columns : [
                {
                    type           : 'resourceInfo',
                    text           : 'Name',
                    showEventCount : true,
                    width          : 220
                },
                {
                    type    : 'action',
                    text    : 'Actions',
                    actions : [{
                        cls     : 'b-fa b-fa-fw b-fa-plus',
                        tooltip : 'Add task',
                        onClick : async({ record }) => {
                            await schedulerPro.project.addEvent({
                                name         : 'New task',
                                startDate    : schedulerPro.startDate,
                                duration     : 4,
                                durationUnit : 'h',
                                resourceId   : record.id
                            });

                            schedulerPro.features.taskEdit.editEvent(schedulerPro.eventStore.last);
                        }
                    }, {
                        cls     : 'b-fa b-fa-fw b-fa-cog',
                        tooltip : 'Settings',
                        onClick : ({ record }) => Toast.show('TODO: Show a cool settings dialog')
                    }, {
                        cls     : 'b-fa b-fa-fw b-fa-copy',
                        tooltip : 'Duplicate resource',
                        onClick : ({ record }) => {
                            schedulerPro.resourceStore.add(record.copy({
                                name : record.name + ' (copy)'
                            }));
                        }
                    }]
                }
            ]
        });

        // Hide loading overlay when scheduler is ready
        schedulerPro.on('paint', () => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        });

        // Handle errors
        schedulerPro.project.on('load', ({ response }) => {
            if (!response || !response.success) {
                console.error('Failed to load project data');
                const container = document.getElementById('scheduler');
                container.innerHTML = `
                    <div class="error-message">
                        Failed to load schedule data. Please refresh the page or contact support.
                    </div>
                `;
            }
        });

        // Expose scheduler to parent window for iframe communication
        if (window.parent && window.parent !== window) {
            window.schedulerPro = schedulerPro;
            
            // Send ready message to parent
            window.parent.postMessage({ 
                type: 'scheduler-ready',
                scheduler: 'SchedulerPro'
            }, '*');
        }

        console.log('âœ… Bryntum SchedulerPro initialized successfully');
    </script>
</body>
</html>