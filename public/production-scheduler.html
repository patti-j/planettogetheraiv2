<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Force refresh timestamp: 2025-10-09 v7.0.0 -->
    <title>Production Schedule - PlanetTogether</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <!-- FontAwesome (now required separately in v7.0.0) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Bryntum Scheduler Pro CSS - Using Material3 Light theme for v7.0.0 -->
    <link rel="stylesheet" href="/material3-light.css?v=7" id="scheduler-theme">
    
    <style>
        /* Minimal essential styles only - let Bryntum handle the rest */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: auto;
        }

        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .toolbar {
            padding: 0.75rem 2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
            overflow-x: auto;
        }

        .scheduler-container {
            flex: 1;
            margin: 1rem;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        #scheduler {
            flex: 1;
            min-height: 0;
        }

        .status-bar {
            padding: 0.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #666;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ff4444;
            color: white;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem;
            text-align: center;
        }
        
        /* Hide elements that might conflict */
        .nav-menu, .max-ai-panel, .constraint-modal {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Production Schedule</h1>
        <div class="header-actions">
            <span id="lastUpdated">Last updated: Never</span>
        </div>
    </div>

    <div class="toolbar">
        <div class="toolbar-group">
            <label for="viewSelector">View:</label>
            <select id="viewSelector">
                <option value="day">Day & Week</option>
                <option value="week">Week & Month</option>
                <option value="month">Month</option>
            </select>
        </div>
        
        <div class="toolbar-group">
            <button id="zoomInBtn" title="Zoom In">
                <i class="fa fa-search-plus"></i>
            </button>
            <button id="zoomOutBtn" title="Zoom Out">
                <i class="fa fa-search-minus"></i>
            </button>
            <button id="zoomToFitBtn" title="Zoom to Fit">
                <i class="fa fa-expand"></i>
            </button>
        </div>

        <div class="toolbar-group">
            <label for="algorithmSelector">Algorithm:</label>
            <select id="algorithmSelector">
                <option value="asap">ASAP (Forward)</option>
                <option value="alap">ALAP (Backward)</option>
                <option value="critical">Critical Path</option>
                <option value="resource">Resource Leveling</option>
            </select>
            <button id="applyAlgorithmBtn">
                <i class="fa fa-play"></i> Apply
            </button>
        </div>

        <div class="toolbar-group">
            <button id="saveSchedule">
                <i class="fa fa-save"></i> Save
            </button>
        </div>
    </div>

    <div class="scheduler-container">
        <div id="scheduler"></div>
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <div class="status-bar">
        <div id="statusMessage">35 operations scheduled</div>
        <div id="resourceUtilization">Resource utilization: 99% (95.0h total)</div>
    </div>

    <!-- Load Bryntum Scheduler Pro UMD -->
    <script src="/schedulerpro.umd.js"></script>
    
    <!-- Initialize the scheduler -->
    <script>
        // Wait for DOM and Bryntum to load
        // Guard to prevent multiple initialization attempts
        let schedulerInitialized = false;
        
        async function initializeScheduler() {
            if (schedulerInitialized) {
                console.log('‚ö†Ô∏è Scheduler already initialized, skipping duplicate initialization');
                return;
            }
            
            try {
                console.log('üöÄ Starting Production Scheduler initialization...');
                schedulerInitialized = true;
                
                // Hide loading overlay
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }

                // Initialize scheduler using global bryntum object
                const { SchedulerPro } = bryntum.schedulerpro;
                
                // Set today's date to September 3, 2025
                const today = new Date('2025-09-03');
                
                // Load PT resources from database
                console.log('üìä Loading PT resources from database...');
                let resources = [];
                
                try {
                    const ptResourcesResponse = await fetch('/api/ptresources');
                    if (ptResourcesResponse.ok) {
                        const ptResources = await ptResourcesResponse.json();
                        console.log(`‚úÖ Loaded ${ptResources.length} PT resources from database`);
                        
                        // Map PT resources to Bryntum format with proper sorting
                        resources = ptResources
                            .filter(res => res.is_active !== false)
                            .sort((a, b) => {
                                // Sort by resource type first
                                const typeOrder = {
                                    'Packaging': 1,
                                    'Production': 2,
                                    'Processing': 3,
                                    'Maintenance': 4,
                                    'Quality': 5
                                };
                                
                                const typeA = typeOrder[a.resource_type] || 99;
                                const typeB = typeOrder[b.resource_type] || 99;
                                
                                if (typeA !== typeB) {
                                    return typeA - typeB;
                                }
                                
                                // Then by name
                                const nameA = a.name || '';
                                const nameB = b.name || '';
                                return nameA.localeCompare(nameB);
                            })
                            .map((resource, index) => ({
                                id: resource.external_id || `RESOURCE_${resource.id}`,
                                name: resource.name || `Resource ${resource.id}`,
                                resourceType: resource.resource_type || 'General',
                                department: resource.department || '',
                                efficiency: resource.efficiency || 100,
                                costPerHour: resource.cost_per_hour || 0,
                                calendar: resource.calendar_id || 'general',
                                sortOrder: index
                            }));
                        
                        // Add explicit sortOrder field to each resource to prevent Bryntum from re-sorting
                        resources = resources.map((resource, index) => ({
                            ...resource,
                            sortOrder: index
                        }));
                    } else {
                        console.warn('‚ö†Ô∏è Could not load PT resources, using demo data');
                    }
                } catch (error) {
                    console.error('‚ùå Error loading PT resources:', error);
                }
                
                // If no resources from database, create demo resources
                if (resources.length === 0) {
                    console.log('üìä Creating demo resources...');
                    resources = [
                        { id: 'FILLER_001', name: 'Bottle Filler Line', resourceType: 'Packaging', sortOrder: 0 },
                        { id: 'FILLER_002', name: 'Can Filler Line', resourceType: 'Packaging', sortOrder: 1 },
                        { id: 'MIXER_001', name: 'Blending Tank 1', resourceType: 'Production', sortOrder: 2 },
                        { id: 'MIXER_002', name: 'Blending Tank 2', resourceType: 'Production', sortOrder: 3 },
                        { id: 'PACKAGE_001', name: 'Labeling Machine', resourceType: 'Packaging', sortOrder: 4 }
                    ];
                }
                
                // Load PT operations from database
                console.log('üìä Loading PT operations from database...');
                let ptOperations = [];
                
                try {
                    const ptOperationsResponse = await fetch('/api/ptoperations');
                    if (ptOperationsResponse.ok) {
                        ptOperations = await ptOperationsResponse.json();
                        console.log(`‚úÖ Loaded ${ptOperations.length} PT operations from database`);
                    }
                } catch (error) {
                    console.error('‚ùå Error loading PT operations:', error);
                }
                
                // Transform PT operations into Bryntum events format
                let events = ptOperations.map((operation, index) => {
                    let startDate = new Date(today);
                    startDate.setDate(startDate.getDate() + Math.floor(index / 4));
                    startDate.setHours(8 + (index % 4) * 3, 0, 0, 0);
                    
                    let endDate = new Date(startDate);
                    endDate.setHours(startDate.getHours() + 2);
                    
                    const eventId = operation.external_id || `OP_${operation.id}`;
                    const resourceId = operation.resource_external_id || resources[index % resources.length]?.id || resources[0]?.id;
                    
                    return {
                        id: eventId,
                        name: operation.name || `Operation ${operation.id}`,
                        startDate: startDate,
                        endDate: endDate,
                        resourceId: resourceId,
                        eventColor: operation.operation_type === 'Setup' ? '#FFA500' : 
                                   operation.operation_type === 'Production' ? '#4CAF50' : 
                                   '#2196F3',
                        priority: operation.priority || 50,
                        operationType: operation.operation_type || 'Production',
                        setupMinutes: operation.setup_minutes || 0,
                        durationMinutes: operation.duration_minutes || 120,
                        constraintType: 'startnoearlierthan',
                        constraintDate: startDate,
                        originalStart: new Date(startDate),
                        originalEnd: new Date(endDate),
                        locked: false,
                        allowOverlap: false
                    };
                });
                
                console.log(`üìä Transformed ${events.length} PT operations into Bryntum events`);
                
                // If no operations from database, create demo operations
                if (events.length === 0) {
                    console.log('üìä Creating demo operations...');
                    const demoStartDate = new Date(today);
                    demoStartDate.setHours(8, 0, 0, 0);
                    
                    events = [
                        {
                            id: 'OP_001',
                            name: 'Mix Batch A-1',
                            startDate: new Date(demoStartDate),
                            endDate: new Date(demoStartDate.getTime() + 2 * 60 * 60 * 1000),
                            resourceId: resources[2]?.id || resources[0]?.id,
                            eventColor: '#4CAF50'
                        },
                        {
                            id: 'OP_002',
                            name: 'Fill Bottles - Batch A-1',
                            startDate: new Date(demoStartDate.getTime() + 3 * 60 * 60 * 1000),
                            endDate: new Date(demoStartDate.getTime() + 5 * 60 * 60 * 1000),
                            resourceId: resources[0]?.id,
                            eventColor: '#2196F3'
                        }
                    ];
                }
                
                // Create scheduler instance with proper Bryntum project engine configuration
                window.scheduler = new SchedulerPro({
                    appendTo: 'scheduler',
                    
                    // Use Material3 theme (default for v7.0.0)
                    // Theme is loaded via CSS file, no need to set here
                    
                    // Basic scheduler configuration
                    startDate: new Date(today.getFullYear(), today.getMonth(), today.getDate() - 1),
                    endDate: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 30),
                    viewPreset: 'dayAndWeek',
                    rowHeight: 50,
                    barMargin: 5,
                    eventColor: null,
                    eventStyle: null,
                    
                    // Proper Bryntum Project configuration using the scheduling engine
                    project: {
                        autoLoad: false,
                        autoSync: false,
                        
                        // Calendar configuration for working hours
                        calendar: 'general',
                        calendarsData: [
                            {
                                id: 'general',
                                name: 'General',
                                intervals: [
                                    {
                                        recurrentStartDate: 'on Mon at 0:00',
                                        recurrentEndDate: 'on Mon at 8:00',
                                        isWorking: false
                                    },
                                    {
                                        recurrentStartDate: 'on Mon at 8:00',
                                        recurrentEndDate: 'on Mon at 17:00',
                                        isWorking: true
                                    },
                                    {
                                        recurrentStartDate: 'on Mon at 17:00',
                                        recurrentEndDate: 'on Tue at 0:00',
                                        isWorking: false
                                    },
                                    {
                                        recurrentStartDate: 'on Tue at 0:00',
                                        recurrentEndDate: 'on Tue at 8:00',
                                        isWorking: false
                                    },
                                    {
                                        recurrentStartDate: 'on Tue at 8:00',
                                        recurrentEndDate: 'on Tue at 17:00',
                                        isWorking: true
                                    },
                                    {
                                        recurrentStartDate: 'on Tue at 17:00',
                                        recurrentEndDate: 'on Wed at 0:00',
                                        isWorking: false
                                    },
                                    {
                                        recurrentStartDate: 'on Wed at 0:00',
                                        recurrentEndDate: 'on Wed at 8:00',
                                        isWorking: false
                                    },
                                    {
                                        recurrentStartDate: 'on Wed at 8:00',
                                        recurrentEndDate: 'on Wed at 17:00',
                                        isWorking: true
                                    },
                                    {
                                        recurrentStartDate: 'on Wed at 17:00',
                                        recurrentEndDate: 'on Thu at 0:00',
                                        isWorking: false
                                    },
                                    {
                                        recurrentStartDate: 'on Thu at 0:00',
                                        recurrentEndDate: 'on Thu at 8:00',
                                        isWorking: false
                                    },
                                    {
                                        recurrentStartDate: 'on Thu at 8:00',
                                        recurrentEndDate: 'on Thu at 17:00',
                                        isWorking: true
                                    },
                                    {
                                        recurrentStartDate: 'on Thu at 17:00',
                                        recurrentEndDate: 'on Fri at 0:00',
                                        isWorking: false
                                    },
                                    {
                                        recurrentStartDate: 'on Fri at 0:00',
                                        recurrentEndDate: 'on Fri at 8:00',
                                        isWorking: false
                                    },
                                    {
                                        recurrentStartDate: 'on Fri at 8:00',
                                        recurrentEndDate: 'on Fri at 17:00',
                                        isWorking: true
                                    },
                                    {
                                        recurrentStartDate: 'on Fri at 17:00',
                                        recurrentEndDate: 'on Mon at 0:00',
                                        isWorking: false
                                    }
                                ]
                            }
                        ]
                    },
                    
                    // Column configuration
                    columns: [
                        {
                            text: 'Resources',
                            field: 'name',
                            width: 220,
                            editor: false
                        }
                    ],
                    
                    // Features configuration
                    features: {
                        eventDrag: {
                            constrainDragToResource: false,
                            showTooltip: true
                        },
                        eventDragCreate: true,
                        eventResize: {
                            showTooltip: true
                        },
                        dependencies: true,
                        dependencyEdit: {
                            showLagField: true
                        },
                        timeRanges: {
                            showCurrentTimeLine: true
                        },
                        eventTooltip: {
                            template: ({ eventRecord }) => {
                                return `
                                    <div>
                                        <strong>${eventRecord.name}</strong><br/>
                                        Resource: ${eventRecord.resource?.name || 'Unassigned'}<br/>
                                        Start: ${eventRecord.startDate?.toLocaleString() || 'Not scheduled'}<br/>
                                        End: ${eventRecord.endDate?.toLocaleString() || 'Not scheduled'}<br/>
                                        Duration: ${eventRecord.duration || 0} hours
                                    </div>
                                `;
                            }
                        },
                        sort: {
                            field: 'sortOrder',
                            ascending: true
                        }
                    }
                });
                
                // Load the inline data into the scheduler project
                await scheduler.project.loadInlineData({
                    resourcesData: resources,
                    eventsData: events,
                    dependenciesData: []
                });
                
                console.log('‚úÖ Scheduler initialized successfully with loaded data');
                
                // Set up toolbar event handlers
                setupToolbarHandlers();
                
                // Update status
                updateStatus();
                
                // Set up periodic status updates
                setInterval(updateStatus, 30000); // Update every 30 seconds
                
                // Initial zoom to fit
                setTimeout(() => {
                    scheduler.zoomToFit({
                        leftMargin: 50,
                        rightMargin: 50
                    });
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Failed to initialize scheduler:', error);
                schedulerInitialized = false;
                
                // Show error message
                const scheduler = document.getElementById('scheduler');
                if (scheduler) {
                    scheduler.innerHTML = `
                        <div class="error-message">
                            Failed to initialize scheduler: ${error.message}
                        </div>
                    `;
                }
            }
        }
        
        function setupToolbarHandlers() {
            // View selector
            const viewSelector = document.getElementById('viewSelector');
            viewSelector?.addEventListener('change', (e) => {
                const viewMap = {
                    'day': 'dayAndWeek',
                    'week': 'weekAndMonth',
                    'month': 'monthAndYear'
                };
                if (window.scheduler) {
                    window.scheduler.viewPreset = viewMap[e.target.value] || 'dayAndWeek';
                }
            });
            
            // Zoom controls
            document.getElementById('zoomInBtn')?.addEventListener('click', () => {
                if (window.scheduler) {
                    window.scheduler.zoomIn();
                }
            });
            
            document.getElementById('zoomOutBtn')?.addEventListener('click', () => {
                if (window.scheduler) {
                    window.scheduler.zoomOut();
                }
            });
            
            document.getElementById('zoomToFitBtn')?.addEventListener('click', () => {
                if (window.scheduler) {
                    window.scheduler.zoomToFit({
                        leftMargin: 50,
                        rightMargin: 50
                    });
                }
            });
            
            // Algorithm application
            document.getElementById('applyAlgorithmBtn')?.addEventListener('click', async () => {
                const algorithmSelector = document.getElementById('algorithmSelector');
                const algorithm = algorithmSelector?.value || 'asap';
                
                if (window.scheduler) {
                    console.log(`Applying ${algorithm.toUpperCase()} algorithm...`);
                    
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'flex';
                    }
                    
                    try {
                        // Apply the algorithm
                        await applySchedulingAlgorithm(algorithm);
                        console.log(`‚úÖ ${algorithm.toUpperCase()} algorithm applied successfully`);
                    } catch (error) {
                        console.error(`‚ùå Error applying ${algorithm} algorithm:`, error);
                    } finally {
                        if (loadingOverlay) {
                            loadingOverlay.style.display = 'none';
                        }
                    }
                }
            });
            
            // Save schedule
            document.getElementById('saveSchedule')?.addEventListener('click', async () => {
                console.log('Saving schedule...');
                // Implement save functionality here
            });
        }
        
        async function applySchedulingAlgorithm(algorithm) {
            if (!window.scheduler || !window.scheduler.project) {
                console.error('Scheduler not initialized');
                return;
            }
            
            const project = window.scheduler.project;
            const events = project.eventStore.records;
            
            switch (algorithm) {
                case 'asap':
                    // Schedule all tasks as soon as possible
                    events.forEach(event => {
                        event.constraintType = 'startnoearlierthan';
                        event.constraintDate = new Date('2025-09-03');
                    });
                    break;
                    
                case 'alap':
                    // Schedule all tasks as late as possible
                    events.forEach(event => {
                        event.constraintType = 'finishnolaterthan';
                        event.constraintDate = new Date('2025-10-03');
                    });
                    break;
                    
                case 'critical':
                    // Identify and highlight critical path
                    console.log('Identifying critical path...');
                    // Critical path logic would go here
                    break;
                    
                case 'resource':
                    // Level resources to minimize overallocation
                    console.log('Leveling resources...');
                    // Resource leveling logic would go here
                    break;
            }
            
            // Refresh the scheduler
            await project.propagate();
            window.scheduler.refresh();
        }
        
        function updateStatus() {
            if (!window.scheduler || !window.scheduler.project) return;
            
            const events = window.scheduler.project.eventStore.count;
            const resources = window.scheduler.project.resourceStore.count;
            
            const statusMessage = document.getElementById('statusMessage');
            if (statusMessage) {
                statusMessage.textContent = `${events} operations scheduled`;
            }
            
            const lastUpdated = document.getElementById('lastUpdated');
            if (lastUpdated) {
                const now = new Date();
                lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString()}`;
            }
            
            // Calculate resource utilization
            let totalHours = 0;
            window.scheduler.project.eventStore.forEach(event => {
                totalHours += event.duration || 0;
            });
            
            const utilization = document.getElementById('resourceUtilization');
            if (utilization) {
                const avgUtilization = resources > 0 ? Math.min(100, Math.round((totalHours / (resources * 40)) * 100)) : 0;
                utilization.textContent = `Resource utilization: ${avgUtilization}% (${totalHours.toFixed(1)}h total)`;
            }
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeScheduler);
        } else {
            // DOM is already ready
            initializeScheduler();
        }
    </script>
</body>
</html>