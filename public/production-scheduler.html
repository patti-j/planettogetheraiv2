<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Production Schedule - PlanetTogether</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <!-- Bryntum Scheduler Pro CSS -->
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
        }

        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .scheduler-container {
            flex: 1;
            position: relative;
            background: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #scheduler {
            flex: 1;
            min-height: 0;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            pointer-events: none; /* Allow clicks through when hidden */
        }
        
        .loading-overlay.hidden {
            display: none !important;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ff4444;
            color: white;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem;
            text-align: center;
        }
        
        /* Customize Bryntum styles for PlanetTogether branding */
        .b-sch-event {
            border-radius: 6px !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12) !important;
        }
        
        .b-sch-event:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        
        /* Dependency lines styling */
        .b-sch-dependency {
            stroke: #666 !important;
            stroke-width: 2 !important;
            opacity: 0.8 !important;
        }
        
        .b-sch-dependency-arrow {
            fill: #666 !important;
            stroke: #666 !important;
        }
        
        .b-sch-dependency:hover {
            stroke: #333 !important;
            stroke-width: 3 !important;
            opacity: 1 !important;
        }
        
        /* Critical path dependency styling */
        .b-sch-dependency.b-critical {
            stroke: #ff4444 !important;
            stroke-width: 3 !important;
        }
        
        .b-sch-dependency.b-critical .b-sch-dependency-arrow {
            fill: #ff4444 !important;
            stroke: #ff4444 !important;
        }
    </style>
</head>
<body>
    <div class="scheduler-container">
        <div id="scheduler"></div>
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Load Bryntum CSS -->
    <link rel="stylesheet" href="/schedulerpro.classic-light.css">
    <!-- Load Bryntum JavaScript -->
    <script src="/schedulerpro.umd.js"></script>
    
    <!-- Custom styles for maintenance periods and icons -->
    <style>
        /* Style for maintenance time ranges - red dashed lines */
        .b-sch-range.maintenance-range {
            background: repeating-linear-gradient(
                -45deg,
                transparent,
                transparent 4px,
                rgba(255, 0, 0, 0.15) 4px,
                rgba(255, 0, 0, 0.15) 8px
            );
            border: 2px dashed #ff0000;
            border-radius: 4px;
        }

        /* Style for recharge time ranges - amber dashed lines */
        .b-sch-range.recharge-range {
            background: repeating-linear-gradient(
                -45deg,
                transparent,
                transparent 4px,
                rgba(255, 193, 7, 0.15) 4px,
                rgba(255, 193, 7, 0.15) 8px
            );
            border: 2px dashed #ffc107;
            border-radius: 4px;
        }

        /* Make the time range labels more prominent */
        .b-sch-range-header {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            font-size: 11px;
        }

        .maintenance-range .b-sch-range-header {
            background-color: #ffebee;
            color: #c62828;
        }

        .recharge-range .b-sch-range-header {
            background-color: #fff8e1;
            color: #f57c00;
        }

        /* Icon styling in resource cells */
        .b-grid-cell .b-resource-info-cell .b-icon {
            margin-right: 8px;
            font-size: 16px;
            opacity: 0.8;
        }

        /* Color coding for different resource types */
        .b-grid-row[data-group="Production Line"] .b-icon {
            color: #2196f3;
        }
        
        .b-grid-row[data-group="Packaging"] .b-icon {
            color: #9c27b0;
        }
        
        .b-grid-row[data-group="Quality"] .b-icon {
            color: #4caf50;
        }
        
        .b-grid-row[data-group="Support"] .b-icon {
            color: #ff9800;
        }
        
        .b-grid-row[data-group="Robots"] .b-icon {
            color: #3f51b5;
        }
        
        .b-grid-row[data-group="Workstations"] .b-icon {
            color: #009688;
        }
        
        .b-grid-row[data-group="Equipment"] .b-icon {
            color: #ffc107;
        }
        
        .b-grid-row[data-group="Operators"] .b-icon {
            color: #00bcd4;
        }
    </style>

    <!-- Toast utility (simple implementation) -->
    <script>
        const Toast = {
            show: function(message) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #333;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 6px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 3000);
            }
        };
        
        // Add animation styles
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>

    <script>
        // Wait for DOM and Bryntum to be ready
        function initScheduler() {
            console.log('Initializing scheduler...');
            
            // Check if Bryntum is loaded
            if (typeof bryntum === 'undefined' || !bryntum.schedulerpro) {
                console.error('âŒ Bryntum library not loaded! Retrying in 500ms...');
                setTimeout(initScheduler, 500);
                return;
            }
            
            console.log('âœ… Bryntum library loaded:', bryntum);
            
            // Hide loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            
            // Initialize Bryntum Scheduler Pro
            const targetElement = document.getElementById('scheduler');
            const { SchedulerPro } = bryntum.schedulerpro;
        
        // Create scheduler instance with inline demo data
        const schedulerPro = new SchedulerPro({
            project : {
                // Inline demo data for PlanetTogether production schedule
                resourcesData : [
                    { 
                        id : 1, 
                        name : 'Assembly Line 1', 
                        type : 'Production Line',
                        iconCls : 'b-fa b-fa-industry',
                        eventColor : 'blue'
                    },
                    { 
                        id : 2, 
                        name : 'Assembly Line 2', 
                        type : 'Production Line',
                        iconCls : 'b-fa b-fa-industry',
                        eventColor : 'blue'
                    },
                    { 
                        id : 3, 
                        name : 'Packaging Station A', 
                        type : 'Packaging',
                        iconCls : 'b-fa b-fa-box',
                        eventColor : 'purple'
                    },
                    { 
                        id : 4, 
                        name : 'Packaging Station B', 
                        type : 'Packaging',
                        iconCls : 'b-fa b-fa-box',
                        eventColor : 'purple'
                    },
                    { 
                        id : 5, 
                        name : 'Quality Control Bay', 
                        type : 'Quality',
                        iconCls : 'b-fa b-fa-clipboard-check',
                        eventColor : 'green'
                    },
                    { 
                        id : 6, 
                        name : 'Maintenance Crew', 
                        type : 'Support',
                        iconCls : 'b-fa b-fa-tools',
                        eventColor : 'orange'
                    },
                    { 
                        id : 7, 
                        name : 'Robot AT4', 
                        type : 'Robots',
                        iconCls : 'b-fa b-fa-robot',
                        eventColor : 'indigo'
                    },
                    { 
                        id : 8, 
                        name : 'Workstation T22', 
                        type : 'Workstations',
                        iconCls : 'b-fa b-fa-desktop',
                        eventColor : 'teal'
                    },
                    { 
                        id : 9, 
                        name : 'Electric Forklift', 
                        type : 'Equipment',
                        iconCls : 'b-fa b-fa-truck',
                        eventColor : 'amber'
                    },
                    { 
                        id : 10, 
                        name : 'Operators Team A', 
                        type : 'Operators',
                        iconCls : 'b-fa b-fa-users',
                        eventColor : 'cyan'
                    }
                ],
                eventsData : [
                    {
                        id           : 1,
                        name         : 'Product A - Batch 001',
                        startDate    : new Date(2025, 2, 23, 6),
                        duration     : 4,
                        durationUnit : 'h',
                        resourceId   : 1,
                        percentDone  : 75,
                        eventColor   : 'blue'
                    },
                    {
                        id           : 2,
                        name         : 'Product B - Batch 002',
                        startDate    : new Date(2025, 2, 23, 11),
                        duration     : 3,
                        durationUnit : 'h',
                        resourceId   : 1,
                        percentDone  : 25,
                        eventColor   : 'green'
                    },
                    {
                        id           : 3,
                        name         : 'Product C - Batch 003',
                        startDate    : new Date(2025, 2, 23, 8),
                        duration     : 5,
                        durationUnit : 'h',
                        resourceId   : 2,
                        percentDone  : 50,
                        eventColor   : 'orange'
                    },
                    {
                        id           : 4,
                        name         : 'Packaging Run 101',
                        startDate    : new Date(2025, 2, 23, 14),
                        duration     : 2,
                        durationUnit : 'h',
                        resourceId   : 3,
                        percentDone  : 100,
                        eventColor   : 'purple'
                    },
                    {
                        id           : 5,
                        name         : 'Packaging Run 102',
                        startDate    : new Date(2025, 2, 23, 16),
                        duration     : 3,
                        durationUnit : 'h',
                        resourceId   : 3,
                        percentDone  : 10,
                        eventColor   : 'purple'
                    },
                    {
                        id           : 6,
                        name         : 'Quality Inspection',
                        startDate    : new Date(2025, 2, 24, 9),
                        duration     : 2,
                        durationUnit : 'h',
                        resourceId   : 5,
                        percentDone  : 0,
                        eventColor   : 'red'
                    },
                    {
                        id           : 7,
                        name         : 'Maintenance Window',
                        startDate    : new Date(2025, 2, 24, 14),
                        duration     : 3,
                        durationUnit : 'h',
                        resourceId   : 6,
                        percentDone  : 0,
                        eventColor   : 'gray'
                    },
                    // Tasks for new resources
                    {
                        id           : 8,
                        name         : 'Robot Assembly Task',
                        startDate    : new Date(2025, 2, 23, 7),
                        duration     : 6,
                        durationUnit : 'h',
                        resourceId   : 7,
                        percentDone  : 60,
                        eventColor   : 'indigo'
                    },
                    {
                        id           : 9,
                        name         : 'Data Entry & Processing',
                        startDate    : new Date(2025, 2, 23, 9),
                        duration     : 4,
                        durationUnit : 'h',
                        resourceId   : 8,
                        percentDone  : 30,
                        eventColor   : 'teal'
                    },
                    {
                        id           : 10,
                        name         : 'Material Transport',
                        startDate    : new Date(2025, 2, 23, 10),
                        duration     : 2,
                        durationUnit : 'h',
                        resourceId   : 9,
                        percentDone  : 100,
                        eventColor   : 'amber'
                    },
                    {
                        id           : 11,
                        name         : 'Manual Assembly',
                        startDate    : new Date(2025, 2, 23, 8),
                        duration     : 5,
                        durationUnit : 'h',
                        resourceId   : 10,
                        percentDone  : 45,
                        eventColor   : 'cyan'
                    },
                    {
                        id           : 12,
                        name         : 'Robot Calibration',
                        startDate    : new Date(2025, 2, 24, 10),
                        duration     : 2,
                        durationUnit : 'h',
                        resourceId   : 7,
                        percentDone  : 0,
                        eventColor   : 'indigo'
                    },
                    {
                        id           : 13,
                        name         : 'Inventory Update',
                        startDate    : new Date(2025, 2, 24, 13),
                        duration     : 1,
                        durationUnit : 'h',
                        resourceId   : 8,
                        percentDone  : 0,
                        eventColor   : 'teal'
                    }
                ],
                dependenciesData : [
                    { id : 1, from : 1, to : 4 },
                    { id : 2, from : 2, to : 5 },
                    { id : 3, from : 4, to : 6 },
                    { id : 4, from : 5, to : 6 }
                ]
            },
            style             : 'font-size:0.85em',
            appendTo          : targetElement,
            autoHeight        : true,
            eventStyle        : 'rounded',
            startDate         : new Date(2025, 2, 23, 4),
            endDate           : new Date(2025, 2, 26),
            // Custom view preset, with more compact display of hours
            viewPreset        : {
                base      : 'hourAndDay',
                tickWidth : 35,
                headers   : [
                    {
                        unit       : 'day',
                        dateFormat : 'ddd DD/MM' //Mon 01/10
                    },
                    {
                        unit       : 'hour',
                        dateFormat : 'H'
                    }
                ]
            },

            // Add time ranges for maintenance periods (red dashed lines)
            timeRanges : [
                {
                    id        : 'maintenance1',
                    startDate : new Date(2025, 2, 23, 17),
                    endDate   : new Date(2025, 2, 23, 19),
                    name      : 'Scheduled Maintenance',
                    cls       : 'maintenance-range',
                    iconCls   : 'b-fa b-fa-wrench'
                },
                {
                    id        : 'maintenance2',
                    startDate : new Date(2025, 2, 24, 6),
                    endDate   : new Date(2025, 2, 24, 8),
                    name      : 'Recharge',
                    cls       : 'recharge-range',
                    iconCls   : 'b-fa b-fa-bolt'
                },
                {
                    id        : 'maintenance3',
                    startDate : new Date(2025, 2, 25, 12),
                    endDate   : new Date(2025, 2, 25, 14),
                    name      : 'Maintenance Window',
                    cls       : 'maintenance-range',
                    iconCls   : 'b-fa b-fa-cog'
                }
            ],

            features : {
                timeRanges : {
                    narrowThreshold : 10,
                    enableResizing  : true,
                    showCurrentTimeLine : true,
                    showHeaderElements : true
                },
                resourceNonWorkingTime : true,
                cellEdit               : true,
                filter                 : true,
                regionResize           : true,
                dependencies           : true,
                dependencyEdit         : true,
                percentBar             : true,
                group                  : 'type',
                sort                   : 'name',
                eventTooltip           : {
                    header : {
                        title      : 'Information',
                        titleAlign : 'start'
                    },
                    tools : [
                        {
                            cls : 'b-fa b-fa-trash',
                            handler() {
                                this.eventRecord.remove();
                                this.hide();
                            }
                        },
                        {
                            cls : 'b-fa b-fa-edit',
                            handler() {
                                schedulerPro.features.taskEdit.editEvent(this.eventRecord);
                            }
                        }
                    ]
                }
            },

            columns : [
                {
                    type           : 'resourceInfo',
                    text           : 'Name',
                    showEventCount : true,
                    width          : 220
                },
                {
                    type    : 'action',
                    text    : 'Actions',
                    actions : [{
                        cls     : 'b-fa b-fa-fw b-fa-plus',
                        tooltip : 'Add task',
                        onClick : async({ record }) => {
                            await schedulerPro.project.addEvent({
                                name         : 'New task',
                                startDate    : schedulerPro.startDate,
                                duration     : 4,
                                durationUnit : 'h',
                                resourceId   : record.id
                            });

                            schedulerPro.features.taskEdit.editEvent(schedulerPro.eventStore.last);
                        }
                    }, {
                        cls     : 'b-fa b-fa-fw b-fa-cog',
                        tooltip : 'Settings',
                        onClick : ({ record }) => Toast.show('TODO: Show a cool settings dialog')
                    }, {
                        cls     : 'b-fa b-fa-fw b-fa-copy',
                        tooltip : 'Duplicate resource',
                        onClick : ({ record }) => {
                            schedulerPro.resourceStore.add(record.copy({
                                name : record.name + ' (copy)'
                            }));
                        }
                    }]
                }
            ]
        });

        // Hide loading overlay immediately after scheduler is created
        setTimeout(() => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
            console.log('ðŸ“Š Scheduler initialized with', schedulerPro.eventStore.count, 'tasks and', schedulerPro.resourceStore.count, 'resources');
            console.log('âœ… Production scheduler fully loaded and ready');
        }, 100);

        // Expose scheduler to parent window for iframe communication
        if (window.parent && window.parent !== window) {
            window.schedulerPro = schedulerPro;
            
            // Send ready message to parent
            window.parent.postMessage({ 
                type: 'scheduler-ready',
                scheduler: 'SchedulerPro'
            }, '*');
        }

            console.log('âœ… Bryntum SchedulerPro initialized successfully');
        }
        
        // Call initScheduler when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initScheduler);
        } else {
            // DOM is already loaded, initialize immediately
            initScheduler();
        }
    </script>
</body>
</html>