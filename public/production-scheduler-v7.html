<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Schedule - PlanetTogether</title>
    
    <!-- Bryntum Scheduler Pro CSS - Stockholm Light theme -->
    <link rel="stylesheet" href="/stockholm-light.css">
    
    <!-- FontAwesome (required separately in v7.0.0) -->
    <link rel="stylesheet" href="/fontawesome/css/all.min.css">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            padding: 1rem 2rem;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: #333;
        }
        
        #scheduler {
            flex: 1;
            min-height: 0;
        }
        
        .status-bar {
            padding: 0.5rem 2rem;
            background: #f5f5f5;
            border-top: 1px solid #ddd;
            font-size: 0.875rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Production Schedule</h1>
    </div>
    
    <div id="scheduler"></div>
    
    <div class="status-bar">
        <span id="status">Loading scheduler...</span>
    </div>
    
    <!-- Bryntum SchedulerPro UMD library -->
    <script src="/schedulerpro.umd.js"></script>
    
    <script>
        // Wait for DOM and Bryntum library to load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Initializing Bryntum Scheduler Pro v7.0.0-alpha.1');
            
            try {
                // Check if Bryntum is loaded
                if (typeof bryntum === 'undefined' || !bryntum.schedulerpro) {
                    throw new Error('Bryntum SchedulerPro library not loaded');
                }
                
                // Get the SchedulerPro constructor
                const { SchedulerPro } = bryntum.schedulerpro;
                
                if (!SchedulerPro) {
                    throw new Error('SchedulerPro constructor not found');
                }
                
                console.log('‚úÖ SchedulerPro constructor found');
                
                // Load data from API
                let resources = [];
                let events = [];
                
                // Load resources
                try {
                    const resResponse = await fetch('/api/ptresources');
                    if (resResponse.ok) {
                        const ptResources = await resResponse.json();
                        resources = ptResources.map((res, index) => ({
                            id: res.resource_id || `R${res.id}`,
                            name: res.name || `Resource ${res.id}`
                        }));
                        console.log(`‚úÖ Loaded ${resources.length} resources`);
                    }
                } catch (error) {
                    console.warn('Could not load resources:', error);
                }
                
                // Load operations as events
                try {
                    const opsResponse = await fetch('/api/ptoperations');
                    if (opsResponse.ok) {
                        const ptOperations = await opsResponse.json();
                        const baseDate = new Date('2025-09-03');
                        
                        events = ptOperations.map((op, index) => {
                            // Generate schedule dates for demo
                            const startDate = new Date(baseDate);
                            startDate.setDate(startDate.getDate() + Math.floor(index / 4));
                            startDate.setHours(8 + (index % 4) * 3, 0, 0, 0);
                            
                            const endDate = new Date(startDate);
                            const duration = parseFloat(op.cycle_hrs) || 2;
                            endDate.setHours(startDate.getHours() + duration);
                            
                            return {
                                id: op.external_id || `OP${op.id}`,
                                name: op.name || `Operation ${op.id}`,
                                resourceId: resources[index % resources.length]?.id || resources[0]?.id,
                                startDate: startDate,
                                endDate: endDate,
                                eventColor: '#2196F3'
                            };
                        });
                        console.log(`‚úÖ Loaded ${events.length} operations`);
                    }
                } catch (error) {
                    console.warn('Could not load operations:', error);
                }
                
                // If no data from API, use demo data
                if (resources.length === 0) {
                    console.log('üìä Using demo data');
                    resources = [
                        { id: 'R1', name: 'Bottle Filler Line' },
                        { id: 'R2', name: 'Brew Kettle 1' },
                        { id: 'R3', name: 'Bright Tank 1' }
                    ];
                    
                    const now = new Date('2025-09-03T08:00:00');
                    events = [
                        {
                            id: 'E1',
                            name: 'Mixing Batch A-1',
                            resourceId: 'R2',
                            startDate: new Date(now),
                            endDate: new Date(now.getTime() + 3 * 3600000),
                            eventColor: '#4CAF50'
                        },
                        {
                            id: 'E2',
                            name: 'Filling Operation B-1',
                            resourceId: 'R1',
                            startDate: new Date(now.getTime() + 4 * 3600000),
                            endDate: new Date(now.getTime() + 7 * 3600000),
                            eventColor: '#2196F3'
                        },
                        {
                            id: 'E3',
                            name: 'Quality Check',
                            resourceId: 'R3',
                            startDate: new Date(now.getTime() + 2 * 3600000),
                            endDate: new Date(now.getTime() + 4 * 3600000),
                            eventColor: '#FF9800'
                        }
                    ];
                }
                
                // Create the scheduler
                console.log('üìä Creating scheduler with Stockholm theme');
                const scheduler = new SchedulerPro({
                    appendTo: 'scheduler',
                    
                    // Set the time range
                    startDate: new Date('2025-09-02'),
                    endDate: new Date('2025-09-16'),
                    
                    // View configuration
                    viewPreset: 'weekAndDay',
                    rowHeight: 60,
                    barMargin: 8,
                    eventStyle: 'plain',
                    
                    // Columns configuration
                    columns: [
                        { 
                            text: 'Resources', 
                            field: 'name', 
                            width: 200,
                            region: 'locked'
                        }
                    ],
                    
                    // Load resources and events directly
                    resources: resources,
                    events: events,
                    
                    // Features
                    features: {
                        eventDrag: true,
                        eventResize: true,
                        eventTooltip: {
                            template: ({ eventRecord }) => `
                                <div style="padding: 10px;">
                                    <strong>${eventRecord.name}</strong><br/>
                                    Start: ${eventRecord.startDate?.toLocaleString()}<br/>
                                    End: ${eventRecord.endDate?.toLocaleString()}
                                </div>
                            `
                        },
                        timeRanges: {
                            showCurrentTimeLine: true
                        }
                    }
                });
                
                console.log('‚úÖ Scheduler created successfully');
                
                // Update status
                const totalHours = events.reduce((sum, event) => {
                    const duration = (event.endDate - event.startDate) / 3600000;
                    return sum + duration;
                }, 0);
                
                const utilization = resources.length > 0 
                    ? Math.round((totalHours / (resources.length * 24 * 14)) * 100)
                    : 0;
                
                document.getElementById('status').textContent = 
                    `${events.length} operations scheduled | Resource utilization: ${utilization}% (${totalHours.toFixed(1)}h total)`;
                
            } catch (error) {
                console.error('‚ùå Failed to initialize scheduler:', error);
                document.getElementById('status').textContent = `Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>